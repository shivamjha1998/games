<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Tap Speed</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100%; overflow: hidden; touch-action: manipulation; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    background: linear-gradient(135deg, #E74C3C, #FD79A8);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    user-select: none; -webkit-user-select: none;
  }
  .screen { display: none; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; position: absolute; top: 0; left: 0; padding: 20px; }
  .screen.active { display: flex; }
  h1 { font-size: clamp(2rem, 8vw, 3.5rem); color: #fff; font-weight: 900; text-shadow: 0 4px 20px rgba(0,0,0,0.2); }
  .sub { color: rgba(255,255,255,0.8); font-size: clamp(0.9rem, 3vw, 1.2rem); margin-top: 8px; }
  .start-btn, .again-btn {
    margin-top: 30px; padding: 16px 48px; font-size: 1.2rem; font-weight: 700;
    background: #fff; color: #E74C3C; border: none; border-radius: 50px;
    cursor: pointer; box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .start-btn:hover, .again-btn:hover { transform: scale(1.05); box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
  .start-btn:active, .again-btn:active { transform: scale(0.95); }

  /* Playing screen */
  .timer { font-size: clamp(1.5rem, 5vw, 2rem); color: rgba(255,255,255,0.9); font-weight: 700; margin-bottom: 10px; }
  .timer.urgent { color: #FDCB6E; animation: pulse 0.4s ease-in-out infinite alternate; }
  @keyframes pulse { to { transform: scale(1.1); } }
  .count { font-size: clamp(3rem, 14vw, 6rem); color: #fff; font-weight: 900; text-shadow: 0 4px 20px rgba(0,0,0,0.2); margin-bottom: 5px; }
  .tps { font-size: clamp(0.9rem, 3vw, 1.1rem); color: rgba(255,255,255,0.7); margin-bottom: 20px; }
  .tap-btn {
    width: clamp(140px, 40vw, 200px); height: clamp(140px, 40vw, 200px);
    border-radius: 50%; background: #fff; border: none; cursor: pointer;
    box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    font-size: clamp(2rem, 8vw, 3rem); font-weight: 900; color: #E74C3C;
    transition: transform 0.06s; position: relative; overflow: hidden;
  }
  .tap-btn:active { transform: scale(0.92); }
  .ripple {
    position: absolute; border-radius: 50%; background: rgba(231,76,60,0.2);
    transform: scale(0); animation: rippleAnim 0.5s ease-out forwards;
    pointer-events: none;
  }
  @keyframes rippleAnim { to { transform: scale(2.5); opacity: 0; } }

  /* Graph */
  .graph-wrap { width: 90%; max-width: 360px; margin-top: 15px; }
  .graph-wrap canvas { width: 100%; height: 60px; border-radius: 8px; }

  /* Game Over */
  .final-count { font-size: clamp(4rem, 16vw, 7rem); color: #fff; font-weight: 900; text-shadow: 0 4px 20px rgba(0,0,0,0.2); }
  .rating { font-size: clamp(1.1rem, 4vw, 1.5rem); color: #FDCB6E; font-weight: 700; margin-top: 8px; }
  .stats { color: rgba(255,255,255,0.8); font-size: clamp(0.85rem, 2.5vw, 1rem); margin-top: 12px; line-height: 1.8; }
  .best-label { color: #FDCB6E; font-weight: 700; }
  .home-link { position: fixed; top: 16px; left: 16px; color: rgba(255,255,255,0.7); text-decoration: none; font-size: 0.9rem; z-index: 10; }
  .home-link:hover { color: #fff; }
</style>
</head>
<body>
<a class="home-link" href="index.html">&#8592; Games</a>

<div class="screen active" id="title-screen">
  <h1>TAP SPEED</h1>
  <p class="sub">How fast can you tap?</p>
  <button class="start-btn" id="start-btn">Start</button>
</div>

<div class="screen" id="play-screen">
  <div class="timer" id="timer">10.00</div>
  <div class="count" id="count">0</div>
  <div class="tps" id="tps">0.0 taps/sec</div>
  <button class="tap-btn" id="tap-btn">TAP</button>
  <div class="graph-wrap"><canvas id="graph" height="60"></canvas></div>
</div>

<div class="screen" id="over-screen">
  <h1>Time's Up!</h1>
  <div class="final-count" id="final-count">0</div>
  <div class="rating" id="rating"></div>
  <div class="stats" id="stats"></div>
  <button class="again-btn" id="again-btn">Play Again</button>
</div>

<script>
(() => {
  const DURATION = 10;
  const LS_KEY = 'tapspeed_best';

  // Elements
  const screens = { title: document.getElementById('title-screen'), play: document.getElementById('play-screen'), over: document.getElementById('over-screen') };
  const timerEl = document.getElementById('timer');
  const countEl = document.getElementById('count');
  const tpsEl = document.getElementById('tps');
  const tapBtn = document.getElementById('tap-btn');
  const graphCanvas = document.getElementById('graph');
  const gCtx = graphCanvas.getContext('2d');
  const finalCountEl = document.getElementById('final-count');
  const ratingEl = document.getElementById('rating');
  const statsEl = document.getElementById('stats');

  let taps, timestamps, startTime, elapsed, running, animId;
  let buckets; // taps per 0.5s bucket

  // --- Web Audio Sound System ---
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let actx;
  function initAudio() { if (!actx) actx = new AudioCtx(); if (actx.state === 'suspended') actx.resume(); }
  function tone(freq, dur, type, vol) { if (!actx) return; const o = actx.createOscillator(), g = actx.createGain(); o.type = type || 'sine'; o.frequency.setValueAtTime(freq, actx.currentTime); g.gain.setValueAtTime(vol || 0.3, actx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, actx.currentTime + dur); o.connect(g); g.connect(actx.destination); o.start(); o.stop(actx.currentTime + dur); }
  function sweep(f1, f2, dur, type, vol) { if (!actx) return; const o = actx.createOscillator(), g = actx.createGain(); o.type = type || 'sine'; o.frequency.setValueAtTime(f1, actx.currentTime); o.frequency.exponentialRampToValueAtTime(f2, actx.currentTime + dur); g.gain.setValueAtTime(vol || 0.3, actx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, actx.currentTime + dur); o.connect(g); g.connect(actx.destination); o.start(); o.stop(actx.currentTime + dur); }
  function sndTap() { tone(600, 0.04, 'square', 0.15); }
  function sndStart() { sweep(400, 800, 0.2, 'sine', 0.25); }
  function sndFinish() { tone(523, 0.1, 'sine', 0.3); setTimeout(() => tone(659, 0.1, 'sine', 0.3), 100); setTimeout(() => tone(784, 0.2, 'sine', 0.3), 200); }

  function show(name) {
    Object.values(screens).forEach(s => s.classList.remove('active'));
    screens[name].classList.add('active');
  }

  function reset() {
    taps = 0; timestamps = []; elapsed = 0; running = false;
    buckets = new Array(DURATION * 2).fill(0);
    countEl.textContent = '0';
    tpsEl.textContent = '0.0 taps/sec';
    timerEl.textContent = DURATION.toFixed(2);
    timerEl.classList.remove('urgent');
    clearGraph();
  }

  function startGame() {
    initAudio();
    sndStart();
    reset();
    show('play');
    running = true;
    startTime = performance.now();
    animId = requestAnimationFrame(tick);
  }

  function tick(now) {
    if (!running) return;
    elapsed = (now - startTime) / 1000;
    const remaining = Math.max(0, DURATION - elapsed);
    timerEl.textContent = remaining.toFixed(2);
    if (remaining < 3) timerEl.classList.add('urgent');
    else timerEl.classList.remove('urgent');

    // Rolling TPS
    const recentCutoff = now - 2000;
    const recent = timestamps.filter(t => t > recentCutoff);
    const tpsVal = recent.length > 1 ? (recent.length / ((now - recent[0]) / 1000)) : 0;
    tpsEl.textContent = tpsVal.toFixed(1) + ' taps/sec';

    drawGraph();

    if (remaining <= 0) { endGame(); return; }
    animId = requestAnimationFrame(tick);
  }

  function onTap(e) {
    if (!running) return;
    sndTap();
    taps++;
    countEl.textContent = taps;
    timestamps.push(performance.now());

    // Bucket
    const bucket = Math.min(Math.floor(elapsed * 2), buckets.length - 1);
    if (bucket >= 0) buckets[bucket]++;

    // Ripple effect
    const rect = tapBtn.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const ripple = document.createElement('span');
    ripple.className = 'ripple';
    ripple.style.width = ripple.style.height = size + 'px';
    if (e && e.clientX) {
      ripple.style.left = (e.clientX - rect.left - size / 2) + 'px';
      ripple.style.top = (e.clientY - rect.top - size / 2) + 'px';
    } else {
      ripple.style.left = (rect.width / 2 - size / 2) + 'px';
      ripple.style.top = (rect.height / 2 - size / 2) + 'px';
    }
    tapBtn.appendChild(ripple);
    setTimeout(() => ripple.remove(), 500);

    // Haptic
    if (navigator.vibrate) navigator.vibrate(10);
  }

  function endGame() {
    running = false;
    cancelAnimationFrame(animId);
    sndFinish();
    const avgTps = taps / DURATION;
    const best = saveBest(taps);

    finalCountEl.textContent = taps;
    ratingEl.textContent = getRating(avgTps);
    statsEl.innerHTML = `${avgTps.toFixed(1)} taps/sec<br><span class="best-label">Best: ${best} taps</span>`;
    show('over');
  }

  function getRating(tps) {
    if (tps < 3) return 'Slow Turtle';
    if (tps < 5) return 'Average Joe';
    if (tps < 8) return 'Quick Tapper';
    if (tps < 11) return 'Speed Demon';
    return 'Superhuman!';
  }

  function saveBest(score) {
    const prev = parseInt(localStorage.getItem(LS_KEY) || '0');
    const best = Math.max(score, prev);
    localStorage.setItem(LS_KEY, best);
    return best;
  }

  // Graph drawing
  function clearGraph() {
    graphCanvas.width = graphCanvas.offsetWidth * 2;
    graphCanvas.height = 60 * 2;
    gCtx.scale(2, 2);
  }

  function drawGraph() {
    const w = graphCanvas.offsetWidth;
    const h = 60;
    gCtx.setTransform(2, 0, 0, 2, 0, 0);
    gCtx.clearRect(0, 0, w, h);

    const maxBucket = Math.max(1, ...buckets);
    const currentBucket = Math.min(Math.floor(elapsed * 2), buckets.length - 1);

    gCtx.beginPath();
    gCtx.moveTo(0, h);
    for (let i = 0; i <= currentBucket; i++) {
      const x = (i / (buckets.length - 1)) * w;
      const y = h - (buckets[i] / maxBucket) * (h - 8);
      if (i === 0) gCtx.lineTo(x, y);
      else {
        const prevX = ((i - 1) / (buckets.length - 1)) * w;
        const prevY = h - (buckets[i - 1] / maxBucket) * (h - 8);
        const cpx = (prevX + x) / 2;
        gCtx.quadraticCurveTo(cpx, prevY, x, y);
      }
    }
    const lastX = (currentBucket / (buckets.length - 1)) * w;
    gCtx.lineTo(lastX, h);
    gCtx.closePath();

    const grad = gCtx.createLinearGradient(0, 0, 0, h);
    grad.addColorStop(0, 'rgba(255,255,255,0.4)');
    grad.addColorStop(1, 'rgba(255,255,255,0.05)');
    gCtx.fillStyle = grad;
    gCtx.fill();

    // Line on top
    gCtx.beginPath();
    for (let i = 0; i <= currentBucket; i++) {
      const x = (i / (buckets.length - 1)) * w;
      const y = h - (buckets[i] / maxBucket) * (h - 8);
      if (i === 0) gCtx.moveTo(x, y);
      else {
        const prevX = ((i - 1) / (buckets.length - 1)) * w;
        const prevY = h - (buckets[i - 1] / maxBucket) * (h - 8);
        gCtx.quadraticCurveTo((prevX + x) / 2, prevY, x, y);
      }
    }
    gCtx.strokeStyle = 'rgba(255,255,255,0.8)';
    gCtx.lineWidth = 2;
    gCtx.stroke();
  }

  // Event listeners
  tapBtn.addEventListener('mousedown', onTap);
  tapBtn.addEventListener('touchstart', e => { e.preventDefault(); onTap(e.touches[0]); }, { passive: false });
  document.addEventListener('keydown', e => {
    if (e.code === 'Space') { e.preventDefault(); if (running) onTap(null); }
  });

  document.getElementById('start-btn').addEventListener('click', startGame);
  document.getElementById('again-btn').addEventListener('click', () => { show('title'); });
  document.getElementById('start-btn').addEventListener('touchstart', e => { e.preventDefault(); startGame(); }, { passive: false });
  document.getElementById('again-btn').addEventListener('touchstart', e => { e.preventDefault(); show('title'); }, { passive: false });

  // Init
  clearGraph();
})();
</script>
</body>
</html>
